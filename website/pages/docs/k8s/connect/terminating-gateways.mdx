---
layout: docs
page_title: Terminating Gateways - Kubernetes
sidebar_title: Terminating Gateways
description: Configuring Terminating Gateways on Kubernetes
---

# Terminating Gateways on Kubernetes

-> 1.8.0+: This feature is available in Consul versions 1.8.0 and higher

-> 0.16.0+: This feature is available in consul-k8s versions 0.16.0 and higher

~> This topic requires familiarity with [Terminating Gateways](https://www.consul.io/docs/connect/terminating-gateway).

Terminating gateways are a new feature included in Consul 1.8. The correlating consul-k8s binary version is
[0.16.0](https://github.com/hashicorp/consul-k8s/blob/master/CHANGELOG.md#0160-june-17-2020), and is required to enable
terminating gateways. If you are using the latest official [consul-helm chart](https://github.com/hashicorp/consul-helm),
and have not customized the [imageK8S](https://www.consul.io/docs/k8s/helm#v-global-imagek8s) configuration for any of
your components, you should be running a compatible version by default.

If you are developing locally, are not using the [consul-helm chart](https://github.com/hashicorp/consul-helm), or have
overridden the imageK8S in your specific configuration, you will need to ensure your environment configuration uses an
image with a compatible binary installed. We recommend using an [official image](https://hub.docker.com/r/hashicorp/consul-k8s)
from HashiCorp. If your organization or scenario requires you to build your own image, you can ensure your version of
the consul-k8s binary is compatible by running `consul-k8s version` from the command line.

Adding a terminating gateway is a multi-step process which has the following general steps:

* Update the helm chart with terminating config options
* Deploying the helm chart
* Accessing the Consul agent
* Register external services with Consul

## Update the helm chart with terminating config options

Minimum required Helm options:

```shell-session
$ cat > config.yaml <<EOF
connectInject:
  enabled: true
terminatingGateways:
  enabled: true
EOF
```

## Deploying the helm chart

Ensure you have the latest consul-helm chart by running the following command:

```shell-session
 $ helm repo add hashicorp https://helm.releases.hashicorp.com
```

Assuming you saved your configuration to a file called config.yaml in the local directory, you can apply your configuration with the following command:

```shell-session
$ helm install -f config.yaml consul hashicorp/consul --wait
```

## Accessing the Consul agent

You can access the Consul server directly from your host via `kubectl port-forward`, this is helpful for interacting with your consul-ui locally as well as to validate connectivity of the application.

```shell-session
$ kubectl port-foward <consul-release>-server-0 8500 &
```

-> Be sure the latest consul binary is installed locally on your host.
[https://releases.hashicorp.com/consul/1.8.0/](https://releases.hashicorp.com/consul/1.8.0/)

-> If TLS and ACLs are enabled, you must set the following environment variables.

```shell-session
$ export CONSUL_HTTP_ADDR=https://localhost:8501
$ export CONSUL_HTTP_TOKEN=$(kubectl get secret <consul-release>--acl-bootstrap-token -o jsonpath={.data.token} | base64 -D)
$ export CONSUL_HTTP_SSL_VERIFY=false
```

## Register external services with Consul

Registering the external services with Consul is a multi-step process which involves the following general steps:
* Register external services with Consul
* Update terminating ACL token (optional)
* Create the configuration entry for the terminating gateway
* Create intentions to allow access from services in the mesh to external service


### Register external services with Consul
Next create a sample external service and register it with Consul.
```shell-session
$ cat > external2.json <<EOF
{
   "Node": "legacy_node",
   "Address": "example.com",
   "NodeMeta": {
     "external-node": "true",
     "external-probe": "true"
   },
   "Service": {
     "ID": "example",
     "Service": "example",
     "Port": 80
   }
}
EOF
```

Next register the external service with Consul:
```shell-session
curl --request PUT --data @external2.json -k http://localhost:8500/v1/catalog/register
```

### Update terminating ACL token (optional)
If ACLs are enabled, update the terminating acl token to have `service: write` permissions on all of the services
being represented by the gateway:
* Create a new policy that includes these permissions
* Update the existing token to attach the new policy
* The CLI command should be run with the `-merge-policies`, `-merge-roles` and `-merge-service-identities` so
nothing is removed from the token

### Create the configuration entry for the terminating gateway
Next write the config entry for the terminating gateway:
```shell-session
$ cat > terminating-gateway.hcl <<EOF
Kind = "terminating-gateway"
Name = "terminating-gateway"
Services = [
 {
   Name = "example"
 }
]
EOF
```

Submit the terminating gateway entry with the Consul cli using this command.

```shell-session
$ consul config write terminating-gateway.hcl
```


-> If using ACLs and TLS
Create intentions to allow access from services in the mesh to the external service

### Define the external services as upstreams for services in the mesh
Finally define and deploy the external services as upstreams for the internal mesh services that want talk to them.
An example deployment can be used in kubernetes which will serve as a static client for the terminating gateway service.

```shell-session
$ cat > static-client.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: static-client
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: static-client
spec:
  replicas: 1
  selector:
    matchLabels:
      app: static-client
  template:
    metadata:
      name: static-client
      labels:
        app: static-client
      annotations:
        "consul.hashicorp.com/connect-inject": "true"
        "consul.hashicorp.com/connect-service-upstreams": "example:1234"
    spec:
      containers:
        # This name will be the service name in Consul.
        - name: static-client
          image: tutum/curl:latest
          # Just spin & wait forever, we'll use `kubectl exec` to demo
          command: [ "/bin/sh", "-c", "--" ]
          args: [ "while true; do sleep 30; done;" ]
       # If ACLs are enabled, the serviceAccountName must match the Consul service name.
      serviceAccountName: static-client
EOF
```

Run the service via `kubectl apply`:
```shell-session
$ kubectl apply -f static-client.yaml
```

-> You can verify connectivity of the services via a curl command:
```shell-session
$ kubectl exec static-client-7cc6df495-qdtkp -- curl -vvvs -H "Host: example.com" http://localhost:1234/
```
